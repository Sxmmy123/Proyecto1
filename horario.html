<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Horario Escolar</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
  table { width: 100%; border-collapse: collapse; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
  th { background-color: #f8f9fa; }
  .hidden { display: none; }
  select.form-select { min-width: 120px; } /* Evita que se achiquen demasiado */
</style>
</head>
<body>
<div class="container py-4">

  <div class="d-flex justify-content-between mb-3">
    <h2>Horario Escolar</h2>
    <a href="index.html" class="btn btn-secondary">Inicio</a>
  </div>

  <h5 id="tituloMaterias" class="hidden">Selecciona las materias que impartes</h5>
  <div id="materiasLista" class="mb-3"></div>

  <table id="tablaHorario">
    <thead>
      <tr>
        <th>Hora</th>
        <th>Lunes</th>
        <th>Martes</th>
        <th>Miércoles</th>
        <th>Jueves</th>
        <th>Viernes</th>
      </tr>
    </thead>
    <tbody>
      <!-- Filas se generan con JS -->
    </tbody>
  </table>

  <div class="mt-3">
    <button class="btn btn-warning" id="btnEditar">Habilitar edición</button>
    <button class="btn btn-success hidden" id="btnAgregarFila">Agregar fila</button>
    <button class="btn btn-danger hidden" id="btnEliminarFila">Eliminar fila</button>
    <button class="btn btn-primary hidden" id="btnGuardar">Guardar cambios</button>
  </div>
</div>

<script>
const materiasDisponibles = [
  "Comunicación y Lenguajes", "Ciencias Sociales", "Educación Física y Deportes",
  "Educación Musical", "Artes Plásticas y Visuales", "Matemática",
  "Tecnología Tecnológica", "Ciencias Naturales", "Valores Espirituales y Religión"
];

// Obtener curso de URL
const params = new URLSearchParams(window.location.search);
const curso = params.get('curso') || 'cursoDefault';

// Modo edición
let modoEdicion = false;

// Cargar horario y materias del curso
let horario = JSON.parse(localStorage.getItem(`horario_${curso}`)) || [];
let materiasSeleccionadas = JSON.parse(localStorage.getItem(`materias_${curso}`)) || [];

// Render checkboxes de materias
function renderMaterias(){
  const div = document.getElementById("materiasLista");
  const titulo = document.getElementById("tituloMaterias");
  if(!modoEdicion){
    div.style.display="none";
    titulo.classList.add("hidden");
    return;
  }
  div.style.display="block";
  titulo.classList.remove("hidden");
  div.innerHTML="";
  materiasDisponibles.forEach(mat=>{
    const chk=document.createElement("div");
    chk.className="form-check form-check-inline";
    chk.innerHTML=`<input class="form-check-input" type="checkbox" value="${mat}" ${materiasSeleccionadas.includes(mat)?"checked":""}>
                   <label class="form-check-label">${mat}</label>`;
    div.appendChild(chk);
  });
  document.querySelectorAll("#materiasLista input").forEach(inp=>{
    inp.addEventListener("change",()=>{
      // Guardar valores actuales de la tabla antes de regenerarla
      guardarValoresTabla();

      materiasSeleccionadas=[...document.querySelectorAll("#materiasLista input:checked")].map(x=>x.value);
      localStorage.setItem(`materias_${curso}`,JSON.stringify(materiasSeleccionadas));
      generarTabla();
    });
  });
}

// Guardar valores actuales de la tabla antes de regenerar
function guardarValoresTabla(){
  const filas = document.querySelectorAll("#tablaHorario tbody tr");
  filas.forEach((tr, filaIdx)=>{
    const dias = ["lunes","martes","miercoles","jueves","viernes"];
    dias.forEach(dia=>{
      const select = tr.querySelector(`#select-${filaIdx}-${dia}`);
      if(select){
        horario[filaIdx][dia] = select.value;
      }
    });
    const horaInput = tr.querySelector("input.hora");
    if(horaInput) horario[filaIdx].hora = horaInput.value;
  });
}

// Generar select
function generarSelect(valor, dia, filaIdx){
  let options = `<option value="">--</option>`;
  options += materiasSeleccionadas.map(m=>`<option value="${m}" ${m===valor?'selected':''}>${m}</option>`).join("");
  const selectId = `select-${filaIdx}-${dia}`;
  return `<select id="${selectId}" class="form-select" ${modoEdicion ? "" : "disabled"}>${options}</select>`;
}

// Generar tabla de horario
function generarTabla(){
  const tbody=document.querySelector("#tablaHorario tbody");
  tbody.innerHTML="";
  horario.forEach((fila, filaIdx)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td><input type="time" value="${fila.hora}" class="form-control hora" ${modoEdicion?"":"readonly"}></td>` +
      ["lunes","martes","miercoles","jueves","viernes"].map(dia=>generarSelect(fila[dia], dia, filaIdx)).map(html=>`<td>${html}</td>`).join("");
    tbody.appendChild(tr);
  });
}

// Botones
const btnEditar = document.getElementById("btnEditar");
const btnAgregarFila = document.getElementById("btnAgregarFila");
const btnEliminarFila = document.getElementById("btnEliminarFila");
const btnGuardar = document.getElementById("btnGuardar");

// Habilitar edición
btnEditar.addEventListener("click", ()=>{
  modoEdicion = true;
  renderMaterias();
  generarTabla();
  btnAgregarFila.classList.remove("hidden");
  btnEliminarFila.classList.remove("hidden");
  btnGuardar.classList.remove("hidden");
  btnEditar.classList.add("hidden");
});

// Agregar fila
btnAgregarFila.addEventListener("click",()=>{
  horario.push({hora:"07:00", lunes:"", martes:"", miercoles:"", jueves:"", viernes:""});
  generarTabla();
});

// Eliminar fila
btnEliminarFila.addEventListener("click",()=>{
  if(horario.length>0){
    horario.pop();
    generarTabla();
  }
});

// Guardar cambios
btnGuardar.addEventListener("click",()=>{
  guardarValoresTabla(); // Asegurar que se guarden los últimos cambios
  localStorage.setItem(`horario_${curso}`, JSON.stringify(horario));
  modoEdicion = false;
  renderMaterias();
  generarTabla();

  btnAgregarFila.classList.add("hidden");
  btnEliminarFila.classList.add("hidden");
  btnGuardar.classList.add("hidden");
  btnEditar.classList.remove("hidden");

  alert("Horario guardado!");
});

// Inicializar
renderMaterias();
generarTabla();
</script>
</body>
</html>
